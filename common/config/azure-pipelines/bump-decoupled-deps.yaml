parameters:
  - name: delayMinutes
    displayName: 'Minutes to wait for packages to propagate before running'
    type: number
    default: 5

variables:
  - name: FORCE_COLOR
    value: 1
  - name: BranchName
    value: 'automated/bump-decoupled-deps'
  - name: CommitMessage
    value: 'chore: bump decoupled local dependencies'

resources:
  pipelines:
    - pipeline: npmPublish
      source: 'rushstack NPM Publish'
      trigger:
        branches:
          include:
            - main
    - pipeline: npmPublishRush
      source: 'rushstack NPM Publish (rush)'
      trigger:
        branches:
          include:
            - main
  repositories:
    - repository: 1esPipelines
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release

extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1esPipelines
  parameters:
    pool:
      name: Azure-Pipelines-1ESPT-ExDShared
      os: windows
    stages:
      - stage:
        jobs:
          - job:
            pool:
              name: publish-rushstack
              os: linux
            steps:
              - checkout: self
                persistCredentials: true

              - bash: |
                  echo "Waiting ${{ parameters.delayMinutes }} minute(s) for packages to propagate to npm..."
                  sleep $(( ${{ parameters.delayMinutes }} * 60 ))
                displayName: 'Wait for packages to propagate'

              - template: /common/config/azure-pipelines/templates/install-node.yaml@self

              - script: 'git config --local user.email rushbot@users.noreply.github.com'
                displayName: 'git config email'

              - script: 'git config --local user.name Rushbot'
                displayName: 'git config name'

              - script: 'node common/scripts/install-run-rush.js install'
                displayName: 'Rush Install'

              - script: 'node common/scripts/install-run-rush.js build --to repo-toolbox --verbose'
                displayName: 'Rush Build (repo-toolbox)'

              - script: 'node repo-scripts/repo-toolbox/lib-commonjs/start.js bump-decoupled-local-dependencies'
                displayName: 'Bump decoupled local dependencies'

              - script: 'node common/scripts/install-run-rush.js update'
                displayName: 'Rush Update'

              - bash: |
                  set -e

                  if git diff --quiet; then
                    echo "No changes detected. Skipping commit and PR."
                    echo "##vso[task.setvariable variable=HasChanges]false"
                    exit 0
                  fi

                  echo "##vso[task.setvariable variable=HasChanges]true"

                  git checkout -B $(BranchName)
                  git add --all
                  git commit -m "$(CommitMessage)"
                displayName: 'Commit dependency changes'

              - bash: |
                  set -e

                  node common/scripts/install-run-rush.js change \
                    --bulk \
                    --bump-type none \
                    --commit-message "chore: generate change files for decoupled dependency bump"
                displayName: 'Generate change files'
                condition: and(succeeded(), eq(variables.HasChanges, 'true'))

              - template: /common/config/azure-pipelines/templates/push-and-create-github-pr.yaml@self
                parameters:
                  BranchName: $(BranchName)
                  PrTitle: $(CommitMessage)
                  PrDescription: 'Automated PR to bump decoupled local dependencies to the latest published versions.'
